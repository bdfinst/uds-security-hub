package model

import (
	"database/sql/driver"
	"encoding/json"
	"errors"
	"fmt"
	"time"
)

// Vulnerability is a struct that represents a vulnerability.
type Vulnerability struct {
	ScanID           uint           `json:"ScanID" gorm:"index"` // Foreign key for the Scan
	ID               uint           `gorm:"primaryKey;autoIncrement"`
	CVSS             CVSS           `json:"CVSS" gorm:"type:jsonb"`
	CreatedAt        time.Time      `json:"CreatedAt" gorm:"autoCreateTime"`
	CweIDs           CweIDs         `json:"CweIDs" gorm:"type:text[]"`
	DataSource       DataSource     `json:"DataSource" gorm:"foreignKey:ID,URL;references:ID,URL"`
	Description      string         `json:"Description"`
	FixedVersion     string         `json:"FixedVersion"`
	InstalledVersion string         `json:"InstalledVersion"`
	LastModifiedDate time.Time      `json:"LastModifiedDate" gorm:"type:timestamp"`
	Layer            Layer          `json:"Layer" gorm:"embedded"`
	PkgIdentifier    PkgIdentifier  `json:"PkgIdentifier" gorm:"foreignKey:PURL,UID;references:PURL,UID"`
	PkgName          string         `json:"PkgName"`
	PkgPath          string         `json:"PkgPath"`
	PrimaryURL       string         `json:"PrimaryURL"`
	PublishedDate    time.Time      `json:"PublishedDate" gorm:"type:timestamp"`
	References       References     `json:"References" gorm:"type:text[]"`
	Severity         string         `json:"Severity"`
	SeveritySource   string         `json:"SeveritySource"`
	Status           string         `json:"Status"`
	Title            string         `json:"Title"`
	UpdatedAt        time.Time      `json:"UpdatedAt" gorm:"autoUpdateTime"`
	VendorSeverity   VendorSeverity `json:"VendorSeverity" gorm:"type:jsonb"`
	VulnerabilityID  string         `json:"VulnerabilityID"`
	Target           string         `json:"Target"`
	Class            string         `json:"Class"`
	Type             string         `json:"Type"`
}

// CVSS is a struct that represents the CVSS score.
type CVSS map[string]CVSSData

type CVSSData struct {
	V3Vector string  `json:"V3Vector"`
	V3Score  float64 `json:"V3Score"`
}

func (c CVSS) Value() (driver.Value, error) {
	return json.Marshal(c)
}

func (c *CVSS) Scan(value interface{}) error {
	bytes, ok := value.([]byte)
	if !ok {
		return fmt.Errorf("CVSS Scan error: expected []byte, got %T", value)
	}
	return json.Unmarshal(bytes, c)
}

type CweIDs []string

func (c CweIDs) Value() (driver.Value, error) {
	return json.Marshal(c)
}

func (c *CweIDs) Scan(value interface{}) error {
	bytes, ok := value.([]byte)
	if !ok {
		return fmt.Errorf("CweIDs Scan error: expected []byte, got %T", value)
	}
	return json.Unmarshal(bytes, c)
}

// DataSource is a struct that represents a data source for vulnerability.
type DataSource struct {
	ID   string `json:"ID" gorm:"primaryKey"`
	Name string `json:"Name" gorm:"primaryKey"`
	URL  string `json:"URL" gorm:"primaryKey"`
}

func (d DataSource) Value() (driver.Value, error) {
	return json.Marshal(d)
}

func (d *DataSource) Scan(value interface{}) error {
	bytes, ok := value.([]byte)
	if !ok {
		return errors.New("invalid type for DataSource")
	}
	return json.Unmarshal(bytes, d)
}

// Layer is a struct that represents a layer in the image.
type Layer struct {
	Digest string `json:"Digest"`
	DiffID string `json:"DiffID"`
}

// PkgIdentifier is a struct that represents a package identifier pURL
type PkgIdentifier struct {
	PURL string `json:"PURL" gorm:"primaryKey"`
	UID  string `json:"UID" gorm:"primaryKey"`
}

func (p PkgIdentifier) Value() (driver.Value, error) {
	return json.Marshal(p)
}

func (p *PkgIdentifier) Scan(value interface{}) error {
	bytes, ok := value.([]byte)
	if !ok {
		return errors.New("invalid type for PkgIdentifier")
	}
	return json.Unmarshal(bytes, p)
}

type References []string

func (r References) Value() (driver.Value, error) {
	return json.Marshal(r)
}

func (r *References) Scan(value interface{}) error {
	bytes, ok := value.([]byte)
	if !ok {
		return errors.New("type assertion to []byte failed")
	}
	return json.Unmarshal(bytes, r)
}

// VendorSeverity is a struct that represents the vendor severity.
type VendorSeverity map[string]int

func (v VendorSeverity) Value() (driver.Value, error) {
	return json.Marshal(v)
}

func (v *VendorSeverity) Scan(value interface{}) error {
	bytes, ok := value.([]byte)
	if !ok {
		return errors.New("invalid type for VendorSeverity")
	}
	return json.Unmarshal(bytes, v)
}

